sudo: required
language: java
jdk:
- openjdk11
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_29e822f9d625_key -iv $encrypted_29e822f9d625_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
- "./gradlew check"
- "./gradlew build"
- docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT .
- |
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    ./set-image.sh prod/$APP_NAME/naiserator.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com

    git add preprod/$APP_NAME/naiserator.yaml
    git add prod/$APP_NAME/naiserator.yaml
    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

    cd ..
    fi
before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
env:
  global:
  - APP_NAME=sparkel
  - DOCKER_IMG_NAME=navikt/sparkel
  - GITHUB_APP_ID=19726
  - secure: j4irpt/Tmhcq2J4d3zOd0NzvqtxqQsUHugujU7qzgU69rEANx45fwhAz4mPMtv+5QGV9khQiHRyK2goIf1wmz+329I7syRlgE3esY8EBi/3/d0KE26/T94Qs06isXrrFjBwAUDQT7dFmhNcGHsrQuGFYV49onyU9bgbClXmurM0fzgUL/E6KJ4e1pMT/0jMveYj7Zk5pxD9fE8KLMw1rvqE8DNkOyJgOFrO6oAXKObPMEDAyanrkYe/VPaE2X1VosB4Da2eTt5icyq3c042Mmj6AUIw6jFNOWSJSnWtn4ox/eRMT2zi3hNApAvrNE7ejekkIg9yyTuiziipfRM0K0tN9O/+GsFGzNkzbTIeRBB8bmmIjC4My7GUBuINLE9clRnFFfy89Hzgv2EWCPbtd8KCqD4sYAQzdSP7IutDLlyrNaj+Wrhts0B0C1VYQNRjpiTgwKP9efAm2c/OrzGVXBn9UUvjzEPRm6lm3C7ECPxSYz94PqrnKP0koTVQwZzrjMvay2BJ0VKU8gnO9thexhe53+NWQeMfX9bYklQ7nYndtpb4WTLmzlAI+WMuk3NH83oq5rJNJCwlIXPEHbBv5+rU6h2WnGjo/Z1EokLkkb3QHjKX1Avt8LK9omPqk7gAuZKf5qgMomN+C7iHY3uanDfWwvxGalEZ0Ov+v5aqfR58=
  - secure: Pu5BWhY8ZH7lMSkRM/7ota5lkeh5IuXgn9Ur6OwuY9Q3c9oK9Y6doPGKixSTjAz9It93HXXTKDD/TQOtV1RvaC/ONxk3mUjxKMhJVYij/yEQ5PhWEPWAaSiPEDjR79RbBxf1ZkCy/pyhopVibEmfezj/1AOdbPtM0fZzSMFHc7qBBewBv387E+afox99QFZOofmfa0i/oRJB92zN7tsiEERazP09wWPHwntEtvZo+3oFTC81NuFOh5lfnWpFpEYH43T2eajw89xAoI1Ru7YzLIpx1Jq45KbqULmnlBRXA2llcetgmOV02HJlcSIM0lPQlRO2jk+Vt/ZEAgUG883Sx368yb8Df/ALxj9S5C0rPKa/VDvJLpP/hEwpJRX05tTPF2SGr6aI/DzAcRd2QgDw534Ix7mAJNCG573j0NkU7H+jKFtkD0mZjzz4N5OFtmI8dq4GUu5xROBn2grRy/pDRFT2AebfHiT0skloAUG4egXXWSk/9EOjCGaCiIuSLkB9uYhTaIPKQxcEyJJeeKKqVQehbTPssVNGzEEwzwOAE+P7ZCqJzhJKKijxb5OUkbe5IXvHmKSTW1tMtxEXtWCBCIE1pPsUV96AUg6Yxd/VoGytL9oo5i5NYfIpRUpjrH/KuXZApbGdV5q3uGauHiZpcP7d4Z5y4BBqfe8DBWmCm9c=
notifications:
  slack:
    secure: Lx2JBWWBZBzGkKQXI5OKEurEciRUa15EfFEWYsdsjb8FM2aTGmSfjKHJOY+hpsg30pBod0jdhJ2PyPmCo5eBNPONdDM1pd4evjlwijljb+MICcOhPYCTWFTKYkKeoSCtBQ4kyw+GW+Hcw1PTGEJHS/PuIszguSrmtGiREgkzJAiNksaU21b4ARbUSF3I2pG1mbgHvFCRFUSdq5AG04rXprLfpVu0ghuK2lSx74kD9qrV8/6Sv60WBdHIPGJbAPX6kCah+aNcSLqjejELjktogHYQNRsTkSlgX0ngd0H68AOqt6tkkg2WMKEXsjHlIx11qhZ70Ln3ZG+nT9UYJ5VpowGzkHb1v2McBBXIRXz5t7Fdjq1lupYxIoj4sS23TbY0zgnpaO53PB7nPpZzwZGHVV0snkLbVymsJUQ1Cc35N05k+Z5jWnJ+JXm/MsPhuxGrTrXY4j2MlBDB3JTXaswI7E2sZtMXeysKGNiah+AZQ8Bn8HzGQB81U0CMlCkFBkK/f0GqIpb9YbmLlZCkXBOk6DU5uUtuzHVDAuFXtbnlBdmbcpxW30mzAihwLDor1KfAfLJbhFBRklho60mzc2oxGrHUlzxG/bewJlfO+Ak+rYsj5NMVmckGGCUNmd+toA9f32ww4ISKiksnoWuBMUQQzKoSvT/qpR0GOrYg8BfsQyk=
